/**
 * JENKINS PIPELINE FOR PLAYWRIGHT E2E TESTS
 * ---------------------------------------------------------
 * This CI pipeline performs the following steps:
 *
 * 1) Checks out the repository
 * 2) Installs Playwright dependencies via Yarn
 * 3) Installs Playwright browsers locally inside the workspace
 * 4) Executes Playwright E2E tests with configurable parameters:
 *      - Browser selection (chromium, firefox, webkit)
 *      - Environment profile (test, staging, prod)
 *      - Headless / headed execution
 * 5) Archives test artifacts (screenshots, videos, results)
 * 6) Generates Allure report if results exist
 * 7) Publishes Allure report via Jenkins Allure plugin
 *
 * Notes:
 * - PLAYWRIGHT_BROWSERS_PATH=0 ensures Playwright does not write
 *   to system directories, preventing permission issues on macOS/Linux agents.
 * - The pipeline is stable, modular, and CI-friendly.
 */

pipeline {
    agent any

    /**
     * Pipeline options:
     * - ANSI color output
     * - Keep only last 10 builds
     * - Timeout protection
     * - Skip remaining stages if build becomes unstable
     */
    options {
        ansiColor('xterm')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 20, unit: 'MINUTES')
        skipStagesAfterUnstable()
    }

    /**
     * User-configurable parameters for CI builds.
     */
    parameters {
        choice(
            name: 'BROWSER',
            choices: ['chromium', 'firefox', 'webkit'],
            description: 'Select browser for Playwright execution'
        )
        choice(
            name: 'ENV',
            choices: ['test', 'staging', 'prod'],
            description: 'Environment for execution'
        )
        booleanParam(
            name: 'HEADLESS',
            defaultValue: true,
            description: 'Run browser in headless mode'
        )
    }

    /**
     * Environment variables used throughout the pipeline.
     */
    environment {
        PLAYWRIGHT_DIR = "${WORKSPACE}/playwright"
        ALLURE_RESULTS_DIR = "${WORKSPACE}/playwright/allure-results"
        ALLURE_REPORT_DIR = "${WORKSPACE}/playwright/allure-report"

        // Prevents Playwright from writing to system cache
        PLAYWRIGHT_BROWSERS_PATH = "0"
        PLAYWRIGHT_SKIP_VALIDATE_HOST_REQUIREMENTS = "true"

        PATH = "/opt/homebrew/bin:/usr/local/bin:${env.PATH}"
    }

    stages {

        /**
         * Checkout the repository from SCM.
         */
        stage('Checkout') {
            steps {
                checkout scm
                echo "=== CODE CHECKED OUT ==="
            }
        }

        /**
         * Install all Node/Yarn dependencies required by Playwright.
         * Also installs Playwright browsers inside workspace.
         */
        stage('Install Dependencies (Yarn)') {
            steps {
                dir("${PLAYWRIGHT_DIR}") {
                    sh '''
                        echo "=== INSTALLING PLAYWRIGHT DEPENDENCIES ==="

                        yarn install --silent

                        echo "Installing Playwright browsers..."
                        npx playwright install chromium firefox webkit

                        echo "Playwright dependencies installed."
                    '''
                }
            }
        }

        /**
         * Executes Playwright E2E tests.
         * Test parameters: browser, headless mode, environment.
         */
        stage('Run Tests') {
            steps {
                script {
                    def headlessFlag = params.HEADLESS ? "" : "--headed"
                    def envName = params.ENV

                    echo "=== STARTING PLAYWRIGHT TESTS ==="
                    echo "Browser: ${params.BROWSER} | ENV: ${envName} | Headless: ${params.HEADLESS}"

                    dir("${PLAYWRIGHT_DIR}") {
                        sh """
                            export ENV=${envName}

                            echo "Running tests..."
                            yarn pw:test --project=${params.BROWSER} ${headlessFlag} || true
                        """
                    }
                }
            }

            /**
             * Archive test results, videos, screenshots, traces.
             */
            post {
                always {
                    script {
                        echo "Archiving artifacts..."

                        def outputs = [
                            "${WORKSPACE}/playwright/allure-results",
                            "${WORKSPACE}/playwright/test-results"
                        ]

                        outputs.each { path ->
                            if (fileExists(path)) {
                                archiveArtifacts artifacts: "${path}/**/*", allowEmptyArchive: true
                            }
                        }
                    }
                }
            }
        }

        /**
         * Generate Allure HTML report if allure-results exist.
         */
        stage('Generate Allure Report') {
            when {
                expression { fileExists("${ALLURE_RESULTS_DIR}") }
            }
            steps {
                dir("${PLAYWRIGHT_DIR}") {
                    sh '''
                        echo "=== GENERATING ALLURE REPORT ==="

                        if [ -d "allure-results" ] && [ "$(ls -A allure-results)" ]; then
                            npx allure generate allure-results --clean -o allure-report
                            echo "Allure report generated."
                        else
                            echo "No allure results found."
                        fi
                    '''
                }
            }
        }
    }

    /**
     * Final pipeline actions always executed.
     * Publishes Allure report via Jenkins plugin if results exist.
     */
    post {
        always {
            script {
                echo "=== FINALIZING PIPELINE ==="

                if (fileExists("${ALLURE_RESULTS_DIR}")) {
                    try {
                        allure([
                            includeProperties: false,
                            results: [[path: "playwright/allure-results"]],
                            reportBuildPolicy: 'ALWAYS'
                        ])
                        echo "Allure report published."
                    } catch (Exception e) {
                        echo "Failed to publish Allure report: ${e.message}"
                    }
                }
            }
        }

        success {
            echo "PIPELINE SUCCESSFUL! üöÄ"
        }

        failure {
            echo "PIPELINE FAILED ‚ùå"
        }
    }
}
