pipeline {
    agent any

    options {
        ansiColor('xterm')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 20, unit: 'MINUTES')
        skipStagesAfterUnstable()
    }

    parameters {
        choice(
            name: 'BROWSER',
            choices: ['chromium', 'firefox', 'webkit'],
            description: 'Select browser for Playwright execution'
        )
        choice(
            name: 'ENV',
            choices: ['test', 'staging', 'prod'],
            description: 'Environment for execution'
        )
        booleanParam(
            name: 'HEADLESS',
            defaultValue: true,
            description: 'Run browser in headless mode'
        )
    }

    environment {
        PLAYWRIGHT_DIR = "${WORKSPACE}/playwright"
        ALLURE_RESULTS_DIR = "${WORKSPACE}/playwright/allure-results"
        ALLURE_REPORT_DIR = "${WORKSPACE}/playwright/allure-report"

        # ‚ùó prevents EACCES permission errors on Mac/Linux
        PLAYWRIGHT_BROWSERS_PATH = "0"
        PLAYWRIGHT_SKIP_VALIDATE_HOST_REQUIREMENTS = "true"

        PATH = "/opt/homebrew/bin:/usr/local/bin:${env.PATH}"
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
                echo "\033[0;36m=== CODE CHECKED OUT ===\033[0m"
            }
        }

        stage('Install Dependencies (Yarn)') {
            steps {
                dir("${PLAYWRIGHT_DIR}") {
                    sh '''
                        echo "\033[0;36m=== INSTALLING PLAYWRIGHT DEPENDENCIES ===\033[0m"

                        yarn install --silent

                        echo "\033[0;34mInstalling Playwright browsers...\033[0m"
                        # NO --with-deps, it breaks OSX/Jenkins!
                        npx playwright install chromium firefox webkit

                        echo "\033[0;32mPlaywright dependencies installed.\033[0m"
                    '''
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    def headlessFlag = params.HEADLESS ? "" : "--headed"
                    def envName = params.ENV

                    echo "\033[0;36m=== STARTING PLAYWRIGHT TESTS ===\033[0m"
                    echo "\033[0;32mBrowser: ${params.BROWSER} | ENV: ${envName} | Headless: ${params.HEADLESS}\033[0m"

                    dir("${PLAYWRIGHT_DIR}") {
                        sh """
                            export ENV=${envName}

                            echo "\033[0;34mRunning tests...\033[0m"
                            yarn pw:test --project=${params.BROWSER} ${headlessFlag} || true
                        """
                    }
                }
            }

            post {
                always {
                    script {
                        echo "\033[0;36mArchiving artifacts...\033[0m"

                        def outputs = [
                            "${WORKSPACE}/playwright/allure-results",
                            "${WORKSPACE}/playwright/test-results"
                        ]

                        outputs.each { path ->
                            if (fileExists(path)) {
                                archiveArtifacts artifacts: "${path}/**/*", allowEmptyArchive: true
                            }
                        }
                    }
                }
            }
        }

        stage('Generate Allure Report') {
            when {
                expression { fileExists("${ALLURE_RESULTS_DIR}") }
            }
            steps {
                dir("${PLAYWRIGHT_DIR}") {
                    sh '''
                        echo "\033[0;36m=== GENERATING ALLURE REPORT ===\033[0m"

                        if [ -d "allure-results" ] && [ "$(ls -A allure-results)" ]; then
                            npx allure generate allure-results --clean -o allure-report
                            echo "\033[0;32mAllure report generated.\033[0m"
                        else
                            echo "\033[0;33mNo allure results found.\033[0m"
                        fi
                    '''
                }
            }
        }
    }

    post {
        always {
            script {
                echo "\033[0;36m=== FINALIZING PIPELINE ===\033[0m"

                if (fileExists("${ALLURE_RESULTS_DIR}")) {
                    try {
                        allure([
                            includeProperties: false,
                            results: [[path: "${ALLURE_RESULTS_DIR}"]],
                            reportBuildPolicy: 'ALWAYS'
                        ])
                        echo "\033[0;32mAllure report published.\033[0m"
                    } catch (Exception e) {
                        echo "\033[0;31mFailed to publish Allure report: ${e.message}\033[0m"
                    }
                }
            }
        }

        success {
            echo "\033[0;32mPIPELINE SUCCESSFUL! üöÄ\033[0m"
        }

        failure {
            echo "\033[0;31mPIPELINE FAILED ‚ùå\033[0m"
        }
    }
}
