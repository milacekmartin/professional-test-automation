pipeline {
    agent any

    options {
        ansiColor('xterm')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 20, unit: 'MINUTES')
        skipStagesAfterUnstable()
    }

    parameters {
        choice(
            name: 'BROWSER',
            choices: ['chromium', 'firefox', 'webkit'],
            description: 'Select browser for Playwright execution'
        )
        choice(
            name: 'ENV',
            choices: ['test', 'staging', 'prod'],
            description: 'Environment for execution'
        )
        booleanParam(
            name: 'HEADLESS',
            defaultValue: true,
            description: 'Run browser in headless mode'
        )
    }

    environment {
        PLAYWRIGHT_DIR = "${WORKSPACE}/playwright"
        ALLURE_RESULTS_DIR = "${WORKSPACE}/playwright/allure-results"
        ALLURE_REPORT_DIR = "${WORKSPACE}/playwright/allure-report"

        // Prevents Playwright from writing to system cache (macOS/Linux)
        PLAYWRIGHT_BROWSERS_PATH = "0"
        PLAYWRIGHT_SKIP_VALIDATE_HOST_REQUIREMENTS = "true"

        PATH = "/opt/homebrew/bin:/usr/local/bin:${env.PATH}"
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
                echo "=== CODE CHECKED OUT ==="
            }
        }

        stage('Install Dependencies (Yarn)') {
            steps {
                dir("${PLAYWRIGHT_DIR}") {
                    sh '''
                        echo "=== INSTALLING PLAYWRIGHT DEPENDENCIES ==="

                        yarn install --silent

                        echo "Installing Playwright browsers..."
                        npx playwright install chromium firefox webkit

                        echo "Playwright dependencies installed."
                    '''
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    def headlessFlag = params.HEADLESS ? "" : "--headed"
                    def envName = params.ENV

                    echo "=== STARTING PLAYWRIGHT TESTS ==="
                    echo "Browser: ${params.BROWSER} | ENV: ${envName} | Headless: ${params.HEADLESS}"

                    dir("${PLAYWRIGHT_DIR}") {
                        sh """
                            export ENV=${envName}

                            echo "Running tests..."
                            yarn pw:test --project=${params.BROWSER} ${headlessFlag} || true
                        """
                    }
                }
            }

            post {
                always {
                    script {
                        echo "Archiving artifacts..."

                        def outputs = [
                            "${WORKSPACE}/playwright/allure-results",
                            "${WORKSPACE}/playwright/test-results"
                        ]

                        outputs.each { path ->
                            if (fileExists(path)) {
                                archiveArtifacts artifacts: "${path}/**/*", allowEmptyArchive: true
                            }
                        }
                    }
                }
            }
        }

        stage('Generate Allure Report') {
            when {
                expression { fileExists("${ALLURE_RESULTS_DIR}") }
            }
            steps {
                dir("${PLAYWRIGHT_DIR}") {
                    sh '''
                        echo "=== GENERATING ALLURE REPORT ==="

                        if [ -d "allure-results" ] && [ "$(ls -A allure-results)" ]; then
                            npx allure generate allure-results --clean -o allure-report
                            echo "Allure report generated."
                        else
                            echo "No allure results found."
                        fi
                    '''
                }
            }
        }
    }

    post {
        always {
            script {
                echo "=== FINALIZING PIPELINE ==="

                if (fileExists("${ALLURE_RESULTS_DIR}")) {
                    try {
                        allure([
                            includeProperties: false,
                            results: [[path: "${ALLURE_RESULTS_DIR}"]],
                            reportBuildPolicy: 'ALWAYS'
                        ])
                        echo "Allure report published."
                    } catch (Exception e) {
                        echo "Failed to publish Allure report: ${e.message}"
                    }
                }
            }
        }

        success {
            echo "PIPELINE SUCCESSFUL! üöÄ"
        }

        failure {
            echo "PIPELINE FAILED ‚ùå"
        }
    }
}
